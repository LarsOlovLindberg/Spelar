<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>spelar.eu</title>
  <meta name="description" content="Systematisk, riskkontrollerad handel baserad på tillfälliga marknadsskillnader." />

  <style>
    :root{
      /* Light, airy theme (kept as primitives via CSS variables) */
      --bg:#f3f4f6;
      --panel:#ffffff;
      --panel2:#f9fafb;
      --text:#111827;
      --muted:#6b7280;
      --border:rgba(17,24,39,.10);
      --accent:#3b82f6;
      --good:#16a34a;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 8px 24px rgba(17,24,39,.08);
      --shadowSoft: 0 4px 6px -1px rgba(17,24,39,.08), 0 2px 4px -2px rgba(17,24,39,.06);
      --radius: 16px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      font-size:18px;
      background:
        radial-gradient(1200px 800px at 20% 0%, rgba(59,130,246,.12), transparent 52%),
        radial-gradient(1200px 800px at 80% 20%, rgba(22,163,74,.10), transparent 52%),
        var(--bg);
      color:var(--text);
    }

    .app{
      display:grid;
      grid-template-columns: 420px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:18px 14px;
      background: transparent;
      border-right:0;
      overflow:auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 12px 14px 12px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadowSoft);
      margin-bottom:12px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(22,163,74,.85));
      display:grid;place-items:center;
      color:#ffffff;font-weight:800;
      letter-spacing:.5px;
      user-select:none;
    }
    .brand h1{
      font-size:22px;
      margin:0;
      line-height:1.1;
    }
    .brand small{
      display:block;
      margin-top:3px;
      color:var(--muted);
      font-size:16px;
      font-family:var(--mono);
    }

    .search{
      margin:10px 0 12px 0;
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px 10px;
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: 12px;
      box-shadow: var(--shadowSoft);
    }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
      color:var(--text);
      font-size:18px;
    }
    .search input::placeholder{color:rgba(169,182,204,.75)}

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .nav-section{
      border:0;
      background: var(--panel);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadowSoft);
    }
    .nav-section .sec-title{
      padding:10px 12px;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      border-bottom:1px solid var(--border);
      background: var(--panel2);
    }
    .nav-items{padding:8px}
    .nav a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px;
      margin:2px 0;
      text-decoration:none;
      color:var(--text);
      border-radius:999px;
      border:1px solid transparent;
      font-size:18px;
    }
    .nav a:hover{
      background: rgba(59,130,246,.10);
      border-color: rgba(59,130,246,.22);
    }
    .nav a.active{
      background: rgba(59,130,246,.14);
      border-color: rgba(59,130,246,.28);
      box-shadow: 0 8px 22px rgba(59,130,246,.10);
    }
    .badge{
      font-size:14px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      font-family:var(--mono);
      user-select:none;
      white-space:nowrap;
    }

    .footer{
      margin-top:12px;
      padding:10px 12px;
      color:var(--muted);
      font-size:15px;
      border:1px dashed var(--border);
      border-radius: var(--radius);
      background: var(--panel2);
    }
    .footer code{font-family:var(--mono);color:rgba(230,237,247,.85)}
    .footer .row{display:flex;justify-content:space-between;gap:10px;margin-top:6px}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--warn);display:inline-block}
    .dot.ok{background:var(--good)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}

    .statusBadge{
      display:inline-flex;
      align-items:center;
      font-family:var(--mono);
      font-size:13px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--panel);
      color: var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .statusBadge.ok{color:var(--good)}
    .statusBadge.warn{color:var(--warn)}
    .statusBadge.bad{color:var(--bad)}

    /* Main */
    .main{
      padding:18px 18px 32px 18px;
      overflow:auto;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border:0;
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadowSoft);
      margin-bottom:14px;
    }

    .crumbs{
      font-size:15px;
      color:var(--muted);
      letter-spacing:.02em;
    }
    .title{
      margin:6px 0 0 0;
      font-size:34px;
      line-height:1.2;
    }

    .kpi{
      font-size:44px;
      font-weight:800;
      letter-spacing:-0.02em;
      line-height:1.05;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    button, .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 11px;
      border-radius: 12px;
      cursor:pointer;
      font-size:16px;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    button:hover, .btn:hover{
      border-color: rgba(106,167,255,.35);
      background: rgba(106,167,255,.10);
    }

    .content{
      border:0;
      border-radius: var(--radius);
      background: transparent;
      box-shadow: none;
      padding:8px;
      min-height: calc(100vh - 18px - 14px - 18px - 100px);
    }

    /* Ops / Live verification panel */
    .opsbar{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      padding:14px;
      border:0;
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadowSoft);
      margin-bottom:14px;
    }
    .opsbar h3{
      margin:0 0 6px 0;
      font-size:22px;
      color:rgba(230,237,247,.96);
    }
    .opsbar p{
      margin:6px 0;
      color:rgba(230,237,247,.92);
      line-height:1.55;
    }
    .opssteps{
      margin:8px 0 0 18px;
      color:rgba(230,237,247,.92);
    }
    .opssteps li{margin:6px 0}
    .opsright{
      border-left:1px solid var(--border);
      padding-left:12px;
    }
    .liveSummary{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:2px;
      color:var(--muted);
      font-size:16px;
    }
    .filelist{margin-top:10px}
    .fileRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background: var(--panel2);
      margin:8px 0;
    }
    .fileRow .left{display:flex;align-items:center;gap:10px;min-width:0}
    .fileRow .name{font-family:var(--mono);font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .fileRow .meta{font-family:var(--mono);font-size:15px;color:var(--muted);white-space:nowrap}
    .fileRow .name{font-family:var(--mono);font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .notice{
      border:1px solid rgba(59,130,246,.20);
      background: rgba(59,130,246,.08);
      border-radius: 12px;
      padding:12px 12px;
      margin-bottom:14px;
    }
    .notice strong{color:rgba(230,237,247,.96)}
    .notice a{color:rgba(230,237,247,.96)}
    .notice .mono{color:rgba(230,237,247,.92)}

    /* Generic content styling */
    h2{margin:0 0 10px 0;font-size:30px;color:var(--text)}
    h3{margin:18px 0 8px 0;font-size:22px;color:var(--text)}
    p{margin:8px 0;color:var(--text);line-height:1.7}
    ul{margin:8px 0 8px 18px;color:var(--text)}
    li{margin:6px 0}
    code, pre{font-family:var(--mono)}
    pre{
      margin:10px 0;
      padding:12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--panel2);
      overflow:auto;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:16px;
      margin-top:12px;
    }
    .card{
      grid-column: span 6;
      border:0;
      border-radius: var(--radius);
      background: var(--panel);
      padding:22px;
      box-shadow: var(--shadowSoft);
    }
    .card h4{margin:0 0 8px 0;font-size:18px;color:var(--text)}
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px;
      color:var(--muted);
      font-size:16px;
    }
    .kv strong{color:rgba(230,237,247,.92);font-weight:600}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:16px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--panel2);
      color:var(--text);
    }

    /* Edge calculator */
    .edgecalc{
      margin-top:10px;
    }
    .edgecalc .row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      margin-bottom:10px;
    }
    .edgecalc .title{font-size:16px;margin:0;color:var(--text)}
    .edgecalc .sub{font-size:14px;margin:0;color:var(--muted)}
    .edgecalc .net{
      text-align:right;
      min-width:140px;
    }
    .edgecalc .net .label{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:700}
    .edgecalc .net .value{font-size:34px;font-weight:900;line-height:1.05}
    .edgebar{
      height:34px;
      border-radius:999px;
      background: var(--panel2);
      border:1px solid var(--border);
      display:flex;
      overflow:hidden;
    }
    .edgebar .seg{
      display:flex;
      align-items:center;
      justify-content:center;
      color:#ffffff;
      font-size:13px;
      font-weight:800;
      padding:0 10px;
      white-space:nowrap;
      min-width:0;
    }
    .edgebar .seg span{overflow:hidden;text-overflow:ellipsis}
    .edgebar .spread{background: var(--bad)}
    .edgebar .fee{background: var(--warn)}
    .edgebar .netpos{background: var(--good)}
    .edgebar .netneg{background: rgba(107,114,128,.45)}
    .edgecalc .foot{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      color:var(--muted);
      border-top:1px solid var(--border);
      padding-top:10px;
      margin-top:12px;
    }
    .edgecalc .foot strong{color:var(--text)}

    /* Lag/latency gauges */
    .gauges{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px}
    .gauge{
      display:flex;
      gap:12px;
      align-items:center;
      border:1px solid var(--border);
      background: var(--panel2);
      border-radius: 14px;
      padding:12px;
    }
    .ring{
      width:44px;height:44px;border-radius:999px;
      border:5px solid rgba(107,114,128,.35);
      flex:0 0 auto;
    }
    .ring.good{border-color: rgba(22,163,74,.85); background: rgba(22,163,74,.10)}
    .ring.bad{border-color: rgba(239,68,68,.85); background: rgba(239,68,68,.10)}
    .ring.warn{border-color: rgba(245,158,11,.85); background: rgba(245,158,11,.10)}
    .gauge .name{font-size:14px;color:var(--muted);margin:0}
    .gauge .val{font-size:22px;font-weight:900;margin:2px 0 0 0;color:var(--text)}
    .gauge .hint{font-size:13px;color:var(--muted);margin:0}

    /* Tables */
    .tablewrap{
      max-width:100%;
      overflow-x:auto;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadowSoft);
      padding: 8px;
      margin-top: 10px;
    }
    table{
      width:max-content;
      min-width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:0;
    }
    th,td{
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      text-align:left;
      font-size:17px;
      white-space:nowrap;
    }
    th{
      color:var(--muted);
      font-weight:700;
      background: var(--panel2);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tbody tr:nth-child(even){background: rgba(17,24,39,.02)}
    tbody tr:hover{background: rgba(59,130,246,.08)}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .num.good{color:var(--good)}
    .num.bad{color:var(--bad)}
    .num.warn{color:var(--warn)}

    /* Mobile */
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
      .sidebar{position:relative;height:auto}
      .content{min-height:auto}
      .card{grid-column: span 12}
      .opsbar{grid-template-columns:1fr}
      .opsright{border-left:0;padding-left:0;border-top:1px solid var(--border);padding-top:12px}
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo">S</div>
        <div>
          <h1>spelar.eu</h1>
          <small id="buildInfo">Systematisk · tidsbegränsad edge · riskkontrollerad</small>
        </div>
      </div>

      <nav class="nav" id="nav"></nav>
    </aside>

    <main class="main">
      <div class="topbar">
        <div>
          <div class="crumbs" id="crumbs">Start</div>
          <h2 class="title" id="pageTitle">Översikt</h2>
        </div>
      </div>

      <section class="opsbar" id="opsBar" aria-live="polite" style="display:none">
        <div>
          <h3>Uppdateringskontroll</h3>
          <p><strong>Det du ser här bygger på snapshots.</strong> Om en fil är gammal betyder det att den inte har uppdaterats nyligen.</p>
          <p class="muted">Tips: klicka fil-länkarna för att se exakt innehåll.</p>
          <div class="liveSummary" id="opsSummary">Laddar status…</div>
        </div>
        <div class="opsright">
          <h3>Filer kopplade till sidan</h3>
          <p class="muted">Portalen använder dessa filer för den här vyn.</p>
          <div class="filelist" id="opsFiles"></div>
        </div>
      </section>

      <section class="content" id="content">
        Laddar…
      </section>
    </main>
  </div>

  <script>
    // ----------------------------
    // ROUTES / NAV STRUCTURE
    // ----------------------------
    const NAV = [
      {
        section: "Start",
        items: [
          { id:"start-home", label:"Startsida", route:"#/start", page:"start_home.html", badge:"start", dataFiles:[] }
        ]
      },
      {
        section: "Strategi & Teknik",
        items: [
          { id:"strategy-about", label:"2.1 Om strategin", route:"#/strategy/about", page:"strategy_about.html", badge:"2.1", dataFiles:[] },
          { id:"strategy-flow", label:"2.2 Hur systemet tänker", route:"#/strategy/flow", page:"strategy_flow.html", badge:"2.2", dataFiles:[] },
          { id:"strategy-risk", label:"2.3 Risk & begränsningar", route:"#/strategy/risk", page:"strategy_risk.html", badge:"2.3", dataFiles:[] },
          { id:"strategy-tech", label:"2.4 Teknisk översikt", route:"#/strategy/tech", page:"strategy_tech.html", badge:"2.4", dataFiles:[] }
        ]
      },
      {
        section: "Transparens / Data",
        items: [
          { id:"transparency-data", label:"Data & exempel", route:"#/data", page:"transparency_data.html", badge:"data", showNotice:false, showOps:true,
            dataFiles:["live_status.json","polymarket_status.json","pm_paper_portfolio.json","pm_paper_positions.csv","pm_paper_trades.csv","edge_signals_live.csv","pm_paper_candidates.csv"] }
        ]
      }
    ];

    const DEFAULT_ROUTE = "#/start";

    // ----------------------------
    // DOM refs
    // ----------------------------
    const navEl = document.getElementById("nav");
    const contentEl = document.getElementById("content");
    const crumbsEl = document.getElementById("crumbs");
    const titleEl = document.getElementById("pageTitle");
    const opsSummaryEl = document.getElementById("opsSummary");
    const opsFilesEl = document.getElementById("opsFiles");
    const opsBarEl = document.getElementById("opsBar");

    // ----------------------------
    // Build sidebar
    // ----------------------------
    function buildNav(){
      navEl.innerHTML = "";

      for (const sec of NAV){

        const wrap = document.createElement("div");
        wrap.className = "nav-section";

        const title = document.createElement("div");
        title.className = "sec-title";
        title.textContent = sec.section;
        wrap.appendChild(title);

        const itemsEl = document.createElement("div");
        itemsEl.className = "nav-items";

        for (const it of sec.items){
          const a = document.createElement("a");
          a.href = it.route;
          a.dataset.route = it.route;

          const left = document.createElement("span");
          left.textContent = it.label;

          const badge = document.createElement("span");
          badge.className = "badge";
          badge.textContent = it.badge;

          a.appendChild(left);
          a.appendChild(badge);
          itemsEl.appendChild(a);
        }

        wrap.appendChild(itemsEl);
        navEl.appendChild(wrap);
      }

      setActiveLink(location.hash || DEFAULT_ROUTE);
    }

    // ----------------------------
    // Router
    // ----------------------------
    function findRoute(hash){
      for (const sec of NAV){
        for (const it of sec.items){
          if (it.route === hash) return { section: sec.section, ...it };
        }
      }
      return null;
    }

    function setActiveLink(hash){
      document.querySelectorAll(".nav a").forEach(a => {
        a.classList.toggle("active", a.dataset.route === hash);
      });
    }

    async function loadPage(pageFile){
      const url = `./pages/${pageFile}`;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`Kunde inte ladda ${url} (${r.status})`);
      return await r.text();
    }

    function fileStatusKind(ageMs, ok){
      if (!ok) return "bad";
      if (!Number.isFinite(ageMs)) return "warn";
      if (ageMs <= 5*60*1000) return "ok";
      if (ageMs <= 30*60*1000) return "warn";
      return "bad";
    }

    function renderOpsFiles(files, results){
      if (!files || files.length === 0) {
        return `<p class="muted">Den här sidan har inga kopplade datafiler.</p>`;
      }

      const byName = new Map((results || []).map(r => [r.file, r]));
      const now = Date.now();

      return files.map(file => {
        const r = byName.get(file);
        const ok = !!(r && r.ok);
        const ageMs = (ok && Number.isFinite(r.lastModified)) ? Math.max(0, now - r.lastModified) : NaN;
        const age = ok ? (Number.isFinite(ageMs) ? formatAge(ageMs) : "? (saknar Last-Modified)") : "saknas/ej läsbar";
        const kind = fileStatusKind(ageMs, ok);
        const statusLabel = !ok ? "Error" : (kind === "ok" ? "Live" : "Väntar");

        const sizeText = (ok && Number.isFinite(r.sizeBytes)) ? formatBytes(r.sizeBytes) : "";
        const meta = [age, sizeText].filter(Boolean).join(" · ");

        const href = `./data/${encodeURIComponent(file)}`;
        const titleParts = [];
        if (ok && Number.isFinite(r.lastModified)) titleParts.push(`Last-Modified: ${formatUtcTimestamp(r.lastModified)}`);
        if (ok && Number.isFinite(r.sizeBytes)) titleParts.push(`Size: ${formatBytes(r.sizeBytes)}`);
        titleParts.push(`Status: ${statusLabel}`);
        const title = titleParts.join("\n");
        return `
          <div class="fileRow">
            <div class="left">
              <span class="dot ${kind}"></span>
              <span class="statusBadge ${kind}">${escapeHtml(statusLabel)}</span>
              <a class="name" href="${href}" target="_blank" rel="noopener">${escapeHtml(file)}</a>
            </div>
            <div class="meta" title="${escapeHtml(title)}">${escapeHtml(meta)}</div>
          </div>
        `;
      }).join("");
    }

    function renderNotice(route){
      const files = (route && Array.isArray(route.dataFiles)) ? route.dataFiles : [];
      const list = files.length
        ? files.map(f => `<li class="mono"><a href="./data/${encodeURIComponent(f)}" target="_blank" rel="noopener">${escapeHtml(f)}</a></li>`).join("")
        : "";

      return `
        <div class="notice">
          <p><strong>Hur du verifierar att detta är uppdaterat:</strong> kontrollera att filerna under uppdateras (ålder sjunker) och att innehållet matchar det du förväntar dig.</p>
          ${files.length ? `<p class="muted" style="margin-top:8px">Den här sidan läser:</p><ul>${list}</ul>` : `<p class="muted">Den här sidan visar främst text/struktur och har inga kopplade datafiler.</p>`}
        </div>
      `;
    }

    function formatAge(ms){
      if (!Number.isFinite(ms) || ms < 0) return "?";
      const s = Math.floor(ms / 1000);
      if (s <= 0) return "just nu";
      if (s < 60) return `${s} sek sedan`;
      const m = Math.floor(s / 60);
      if (m < 60) return `${m} min sedan`;
      const h = Math.floor(m / 60);
      if (h < 24){
        const mm = m % 60;
        return mm ? `${h} h ${mm} min sedan` : `${h} h sedan`;
      }
      const d = Math.floor(h / 24);
      return d === 1 ? `1 dygn sedan` : `${d} dygn sedan`;
    }

    function formatBytes(bytes){
      if (!Number.isFinite(bytes) || bytes < 0) return "";
      if (bytes < 1024) return `${Math.round(bytes)} B`;
      const kb = bytes / 1024;
      if (kb < 1024) return `${kb.toFixed(1)} KB`;
      const mb = kb / 1024;
      return `${mb.toFixed(1)} MB`;
    }

    function parseTimestampMs(s){
      if (!s) return NaN;
      const t = Date.parse(String(s));
      return Number.isFinite(t) ? t : NaN;
    }

    function formatUtcTimestamp(ms){
      if (!Number.isFinite(ms)) return "?";
      try{
        return new Date(ms).toISOString().slice(0,19).replace("T"," ") + " UTC";
      }catch(_e){
        return "?";
      }
    }

    function renderBlockMetaLine(file, lastModifiedMs){
      const now = Date.now();
      const ageMs = Number.isFinite(lastModifiedMs) ? Math.max(0, now - lastModifiedMs) : NaN;
      const age = Number.isFinite(ageMs) ? formatAge(ageMs) : "?";
      const ts = formatUtcTimestamp(lastModifiedMs);
      return `<p class="muted" style="margin:8px 0 0 0">Fil: <span class="mono">${escapeHtml(String(file || ""))}</span> · Senast uppdaterad: <span class="mono">${escapeHtml(age)}</span> <span class="muted mono">(${escapeHtml(ts)})</span></p>`;
    }

    async function getLastModifiedForDataFile(file){
      const url = `./data/${file}`;
      // Prefer HEAD (fast). Fallback to GET if HEAD is blocked.
      try{
        const r = await fetch(url, { method: "HEAD", cache: "no-store" });
        if (r.ok){
          const lm = r.headers.get("Last-Modified");
          const cl = r.headers.get("Content-Length");
          const sizeBytes = cl ? Number(cl) : NaN;
          if (lm) return { ok:true, file, lastModified: new Date(lm).getTime(), sizeBytes };
          // Some servers omit Last-Modified; treat as unknown.
          return { ok:true, file, lastModified: NaN, sizeBytes };
        }
      }catch(_e){ /* ignore */ }

      try{
        const r2 = await fetch(url, { cache: "no-store" });
        if (!r2.ok) return { ok:false, file, lastModified: NaN, sizeBytes: NaN };
        const lm2 = r2.headers.get("Last-Modified");
        const cl2 = r2.headers.get("Content-Length");
        const sizeBytes2 = cl2 ? Number(cl2) : NaN;
        return { ok:true, file, lastModified: lm2 ? new Date(lm2).getTime() : NaN, sizeBytes: sizeBytes2 };
      }catch(_e2){
        return { ok:false, file, lastModified: NaN, sizeBytes: NaN };
      }
    }

    async function updateLiveStatusForRoute(route){
      const files = (route && Array.isArray(route.dataFiles)) ? route.dataFiles : [];
      if (files.length === 0){
        opsSummaryEl.textContent = "Den här sidan har inga datafiler kopplade.";
        opsFilesEl.innerHTML = renderOpsFiles(files, []);
        return;
      }

      const results = await Promise.all(files.map(getLastModifiedForDataFile));
      const ok = results.some(r => r.ok);
      if (!ok){
        opsSummaryEl.textContent = "Kunde inte läsa någon av sidans datafiler. Kontrollera att filerna finns uppladdade.";
        opsFilesEl.innerHTML = renderOpsFiles(files, results);
        return;
      }

      // Choose the newest known timestamp.
      const now = Date.now();
      let best = null;
      for (const r of results){
        if (!r.ok) continue;
        if (!Number.isFinite(r.lastModified)) continue;
        if (!best || r.lastModified > best.lastModified) best = r;
      }

      if (!best){
        // No Last-Modified available; still allow verification via direct file links.
        opsSummaryEl.innerHTML = `Data går att hämta, men servern skickar ingen <span class="mono">Last-Modified</span>. Klicka filerna för att verifiera innehåll.`;
        opsFilesEl.innerHTML = renderOpsFiles(files, results);
        return;
      }

      const ageMs = Math.max(0, now - best.lastModified);
      const age = formatAge(ageMs);

      opsSummaryEl.innerHTML = `Nyast uppdaterad fil: <span class="mono">${escapeHtml(best.file)}</span> · ålder <span class="mono">${escapeHtml(age)}</span>.`;
      opsFilesEl.innerHTML = renderOpsFiles(files, results);
    }

    async function render(){
      const hash = location.hash || DEFAULT_ROUTE;
      const route = findRoute(hash) || findRoute(DEFAULT_ROUTE);

      if (!route){
        location.hash = DEFAULT_ROUTE;
        return;
      }

      setActiveLink(route.route);

      crumbsEl.textContent = `${route.section}`;
      titleEl.textContent = route.label;

      const showOps = !!route.showOps;
      opsBarEl.style.display = showOps ? "" : "none";

      try{
        const html = await loadPage(route.page);
        contentEl.innerHTML = (route.showNotice ? renderNotice(route) : "") + html;

        // Render CSV/JSON blocks placed inside pages
        await hydrateDataBlocks();

        if (showOps){
          await updateLiveStatusForRoute(route);
        }
      }catch(e){
        contentEl.innerHTML = `
          <h2>Kunde inte ladda sidan</h2>
          <p class="muted mono">${escapeHtml(String(e))}</p>
          <p>Kontrollera att filen finns i <span class="mono">/web/pages/</span>.</p>
        `;
      }
    }

    // ----------------------------
    // CSV/JSON helpers (for /web/data/)
    // ----------------------------
    function escapeHtml(s){
      return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function parseCsv(text){
      // Minimal CSV parser (handles commas, quotes).
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      while (i < text.length){
        const c = text[i];

        if (inQuotes){
          if (c === '"'){
            if (text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        }else{
          if (c === '"'){ inQuotes = true; i++; continue; }
          if (c === ","){ row.push(field); field=""; i++; continue; }
          if (c === "\n"){
            row.push(field); field="";
            if (row.length > 1 || row[0] !== "") rows.push(row);
            row = []; i++; continue;
          }
          if (c === "\r"){ i++; continue; }
          field += c; i++; continue;
        }
      }
      row.push(field);
      if (row.length > 1 || row[0] !== "") rows.push(row);
      return rows;
    }

    function tryParseNumber(s){
      if (typeof s === "number") return s;
      if (s === null || s === undefined) return NaN;
      const t = String(s).trim();
      if (!t) return NaN;
      const cleaned = t.endsWith("%") ? t.slice(0, -1) : t;
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : NaN;
    }

    function numClass(n){
      if (!Number.isFinite(n)) return "";
      if (n > 0) return "num good";
      if (n < 0) return "num bad";
      return "num";
    }

    function humanizeReason(reason){
      const r = String(reason || "").trim();
      if (!r) return "";
      const map = {
        // lead-lag / edge_calculator_live.csv
        "spot_move_too_small": "Move too small",
        "low_edge": "Edge too low",
        "net_edge_too_low": "Net edge too low",
        "spread_too_high": "Spread too high",
        "insufficient_liquidity": "Insufficient liquidity",
        "throttled": "Throttled",
        "lag_too_short": "Lag too short",
        "warmup": "Warmup",
        "stale_or_warmup": "Stale/Warmup",
        "avoid_price_zone": "Price filtered",
        "avoid_price_zone_executable": "Price filtered (executable)",
        "hold": "Holding",
        "enter": "Entered",
        "edge_exit": "Exit (edge faded)",
        "max_hold": "Exit (max hold)",
        "stop": "Exit (stop)",
      };
      return map[r] || r;
    }

    function renderTableFromRows(rows, maxRows=200){
      if (!rows || rows.length === 0) return `<p class="muted">Ingen data.</p>`;
      const head = rows[0];
      const body = rows.slice(1, maxRows + 1);

      const headLower = head.map(h => String(h || "").toLowerCase());
      const shouldColor = (hl) => hl.includes("pnl") || hl.includes("edge") || hl.includes("return") || hl.includes("roi");

      const th = head.map(h => `<th>${escapeHtml(h)}</th>`).join("");
      const tr = body.map(r => {
        const tds = head.map((_, idx) => {
          const v = r[idx] ?? "";
          const hl = headLower[idx] || "";
          let cls = "mono";
          if (shouldColor(hl)){
            const n = tryParseNumber(v);
            const nc = numClass(n);
            if (nc) cls += " " + nc;
          }
          return `<td class="${cls}">${escapeHtml(String(v))}</td>`;
        }).join("");
        return `<tr>${tds}</tr>`;
      }).join("");

      const note = rows.length - 1 > maxRows
        ? `<p class="muted">Visar ${maxRows} av ${rows.length - 1} rader.</p>` : "";

      return `
        ${note}
        <div class="tablewrap">
          <table>
            <thead><tr>${th}</tr></thead>
            <tbody>${tr}</tbody>
          </table>
        </div>
      `;
    }

    async function hydrateDataBlocks(){
      // Shared numeric formatting helpers used by multiple blocks.
      const fmt2 = (n) => Number.isFinite(n) ? n.toFixed(2) : "";

      const csvBlocks = Array.from(contentEl.querySelectorAll("[data-csv]"));
      for (const el of csvBlocks){
        const file = el.getAttribute("data-csv");
        const maxRows = parseInt(el.getAttribute("data-max-rows") || "200", 10);
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const text = await r.text();
          const rows = parseCsv(text);
          el.innerHTML = renderBlockMetaLine(file, lmMs) + renderTableFromRows(rows, maxRows);
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda CSV: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }

      const jsonBlocks = Array.from(contentEl.querySelectorAll("[data-json]"));
      for (const el of jsonBlocks){
        const file = el.getAttribute("data-json");
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const obj = await r.json();
          el.innerHTML = renderBlockMetaLine(file, lmMs) + `<pre>${escapeHtml(JSON.stringify(obj, null, 2))}</pre>`;
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda JSON: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }

      // Paper portfolio summary
      const paperBlocks = Array.from(contentEl.querySelectorAll("[data-paper-portfolio]"));
      for (const el of paperBlocks){
        const file = el.getAttribute("data-paper-portfolio");
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const obj = await r.json();

          const cash = Number(obj?.cash_usd ?? NaN);
          const equity = Number(obj?.equity_usd ?? NaN);
          const upnl = Number(obj?.unrealized_pnl_usd ?? 0);
          const rpnl = Number(obj?.realized_pnl_usd ?? 0);
          const openPos = Number(obj?.open_positions ?? 0);
          const ts = String(obj?.generated_at ?? "");
          const tsMs = parseTimestampMs(ts);
          const ageMs = Number.isFinite(tsMs)
            ? Math.max(0, Date.now() - tsMs)
            : (Number.isFinite(lmMs) ? Math.max(0, Date.now() - lmMs) : NaN);
          const rel = Number.isFinite(ageMs) ? formatAge(ageMs) : "–";
          const abs = ts || (Number.isFinite(lmMs) ? formatUtcTimestamp(lmMs) : "–");

          const rpnlCls = numClass(rpnl);
          const upnlCls = numClass(upnl);
          el.innerHTML = `
            ${renderBlockMetaLine(file, lmMs)}
            <div class="grid">
              <div class="card">
                <h4>Cash</h4>
                <div class="mono kpi">$${escapeHtml(fmt2(cash))}</div>
                <p class="muted">Open positions: <span class="mono">${escapeHtml(String(openPos))}</span></p>
              </div>
              <div class="card">
                <h4>Equity</h4>
                <div class="mono kpi">$${escapeHtml(fmt2(equity))}</div>
                <p class="muted">PnL: <span class="mono ${escapeHtml(rpnlCls)}">${escapeHtml(fmt2(rpnl))}</span> realized, <span class="mono ${escapeHtml(upnlCls)}">${escapeHtml(fmt2(upnl))}</span> unrealized</p>
              </div>
              <div class="card">
                <h4>Senast uppdaterad</h4>
                <p class="mono">${escapeHtml(rel)}</p>
                <p class="muted mono">${escapeHtml(abs)}</p>
                <p class="muted">Källa: <span class="mono">${escapeHtml(String(file))}</span></p>
              </div>
            </div>
          `;
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda paper-portfolio: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }

      // Live status summary
      const liveBlocks = Array.from(contentEl.querySelectorAll("[data-live-status]"));
      for (const el of liveBlocks){
        const file = el.getAttribute("data-live-status");
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const obj = await r.json();

          const tradingMode = String(obj?.trading_mode ?? "–");
          const strategyMode = String(obj?.strategy_mode ?? obj?.mode ?? "–");
          const killswitch = (obj?.killswitch ?? obj?.kill_switch);
          const maxOrders = obj?.pm_max_orders_per_tick ?? obj?.max_orders_per_tick;
          const orderSize = obj?.pm_order_size_shares ?? obj?.order_size_shares;

          const netEdgeMin = tryParseNumber(obj?.lead_lag_net_edge_min_pct);
          const spreadCap = tryParseNumber(obj?.lead_lag_spread_cost_cap_pct);
          const minLagMs = tryParseNumber(obj?.lead_lag_min_market_lag_ms);
          const minNotional = tryParseNumber(obj?.lead_lag_min_trade_notional_usdc);
          const hasGates = [netEdgeMin, spreadCap, minLagMs, minNotional].some(Number.isFinite);

          const moveBase = tryParseNumber(obj?.lead_lag_spot_move_min_pct_base);
          const moveDyn = tryParseNumber(obj?.lead_lag_spot_move_min_pct_dynamic);
          const noisePct = tryParseNumber(obj?.lead_lag_spot_noise_pct);
          const spreadCostPct = tryParseNumber(obj?.lead_lag_spread_cost_pct);
          const hasMoveMeta = [moveBase, moveDyn, noisePct, spreadCostPct].some(Number.isFinite);
          const ts = String(obj?.ts ?? obj?.generated_at ?? obj?.updated_at ?? "");
          const tsMs = parseTimestampMs(ts);
          const ageMs = Number.isFinite(tsMs)
            ? Math.max(0, Date.now() - tsMs)
            : (Number.isFinite(lmMs) ? Math.max(0, Date.now() - lmMs) : NaN);
          const rel = Number.isFinite(ageMs) ? formatAge(ageMs) : "–";
          const abs = ts || (Number.isFinite(lmMs) ? formatUtcTimestamp(lmMs) : "–");

          const liveDot = tradingMode.toLowerCase() === "live" ? "bad" : "ok";
          const ksText = (killswitch === null || killswitch === undefined) ? "–" : (killswitch ? "ON" : "OFF");
          const ksCls = (killswitch === null || killswitch === undefined) ? "" : (killswitch ? "num bad" : "num good");

          el.innerHTML = `
            ${renderBlockMetaLine(file, lmMs)}
            <div class="grid">
              <div class="card">
                <h4>Trading mode</h4>
                <p class="pill"><span class="dot ${escapeHtml(liveDot)}"></span><span class="mono">${escapeHtml(tradingMode)}</span></p>
              </div>
              <div class="card">
                <h4>Strategy mode</h4>
                <div class="mono kpi">${escapeHtml(strategyMode)}</div>
                ${hasGates ? `
                  <p class="muted" style="margin-top:10px">Gates (lead–lag)</p>
                  <p class="muted">Net edge min: <span class="mono">${escapeHtml(Number.isFinite(netEdgeMin) ? `${netEdgeMin.toFixed(3)}%` : "–")}</span></p>
                  <p class="muted">Spread cap: <span class="mono">${escapeHtml(Number.isFinite(spreadCap) ? `${spreadCap.toFixed(3)}%` : "–")}</span></p>
                  <p class="muted">Min lag: <span class="mono">${escapeHtml(Number.isFinite(minLagMs) ? `${Math.round(minLagMs)}ms` : "–")}</span></p>
                  <p class="muted">Min notional: <span class="mono">${escapeHtml(Number.isFinite(minNotional) ? `$${fmt2(minNotional)}` : "–")}</span></p>
                ` : ``}
                ${hasMoveMeta ? `
                  <p class="muted" style="margin-top:10px">Move threshold (adaptive)</p>
                  <p class="muted">Move min base: <span class="mono">${escapeHtml(Number.isFinite(moveBase) ? `${moveBase.toFixed(3)}%` : "–")}</span></p>
                  <p class="muted">Move min dyn: <span class="mono">${escapeHtml(Number.isFinite(moveDyn) ? `${moveDyn.toFixed(3)}%` : "–")}</span></p>
                  <p class="muted">Spot noise (est): <span class="mono">${escapeHtml(Number.isFinite(noisePct) ? `${noisePct.toFixed(3)}%` : "–")}</span></p>
                  <p class="muted">Spread cost (half): <span class="mono">${escapeHtml(Number.isFinite(spreadCostPct) ? `${spreadCostPct.toFixed(3)}%` : "–")}</span></p>
                ` : ``}
              </div>
              <div class="card">
                <h4>Killswitch</h4>
                <div class="mono kpi ${escapeHtml(ksCls)}">${escapeHtml(ksText)}</div>
              </div>
              <div class="card">
                <h4>PM order size</h4>
                <div class="mono kpi">${escapeHtml(String(orderSize ?? "–"))}</div>
                <p class="muted">shares per order</p>
              </div>
              <div class="card">
                <h4>Max orders per tick</h4>
                <div class="mono kpi">${escapeHtml(String(maxOrders ?? "–"))}</div>
              </div>
              <div class="card">
                <h4>Senast uppdaterad</h4>
                <p class="mono">${escapeHtml(rel)}</p>
                <p class="muted mono">${escapeHtml(abs)}</p>
              </div>
            </div>
          `;
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda live-status: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }

      // Lead-lag edge calculator
      const edgeCalcBlocks = Array.from(contentEl.querySelectorAll("[data-edge-calculator]"));
      for (const el of edgeCalcBlocks){
        const file = el.getAttribute("data-edge-calculator");
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const text = await r.text();
          const rows = parseCsv(text);
          if (rows.length < 2){
            el.innerHTML = renderBlockMetaLine(file, lmMs) + `<p class="muted">Ingen data.</p>`;
            continue;
          }

          const head = rows[0].map(h => String(h || "").trim());
          const idx = (name) => head.findIndex(h => h === name);
          const last = rows[rows.length - 1];

          const ts = String(last[idx("ts")] ?? "");
          const market = String(last[idx("market")] ?? "");
          const raw = tryParseNumber(last[idx("raw_edge")]);
          const spread = tryParseNumber(last[idx("spread_cost")]);
          const fees = tryParseNumber(last[idx("fees")]);
          const net = tryParseNumber(last[idx("net_edge")]);
          const status = String(last[idx("execution_status")] ?? "");
          const reason = String(last[idx("reason")] ?? "");
          const reasonHuman = humanizeReason(reason);

          const gross = Number.isFinite(raw) ? Math.abs(raw) : NaN;
          const spreadAbs = Number.isFinite(spread) ? Math.abs(spread) : 0;
          const feesAbs = Number.isFinite(fees) ? Math.abs(fees) : 0;
          const netAbs = Number.isFinite(net) ? Math.abs(net) : 0;

          const pct = (x) => (gross > 0 && Number.isFinite(x)) ? Math.max(0, Math.min(100, (x / gross) * 100)) : 0;
          let wSpread = pct(spreadAbs);
          let wFees = pct(feesAbs);
          let wNet = Math.max(0, 100 - wSpread - wFees);

          // If net edge is negative, show no green segment.
          const netIsGood = Number.isFinite(net) && net > 0;
          if (!netIsGood) wNet = 0;

          const fmt = (n) => Number.isFinite(n) ? `${n.toFixed(3)}%` : "–";
          const netCls = netIsGood ? "num good" : "num warn";
          const segNetCls = netIsGood ? "netpos" : "netneg";
          const statusText = status ? status : (netIsGood ? "TRIGGERED" : "SKIPPED");

          el.innerHTML = `
            ${renderBlockMetaLine(file, lmMs)}
            <div class="edgecalc">
              <div class="row">
                <div>
                  <p class="title"><strong>${escapeHtml(market || "–")}</strong></p>
                  <p class="sub mono">${escapeHtml(ts || "–")}</p>
                </div>
                <div class="net">
                  <div class="label">Netto edge</div>
                  <div class="value mono ${escapeHtml(netCls)}">${escapeHtml(fmt(net))}</div>
                </div>
              </div>
              <div class="edgebar" role="img" aria-label="Brutto edge uppdelad i spread, avgifter och netto">
                <div class="seg spread" style="width:${wSpread.toFixed(2)}%"><span>Spread ${escapeHtml(fmt(-spreadAbs))}</span></div>
                <div class="seg fee" style="width:${wFees.toFixed(2)}%"><span>Fee ${escapeHtml(fmt(-feesAbs))}</span></div>
                <div class="seg ${segNetCls}" style="width:${wNet.toFixed(2)}%"><span>Netto ${escapeHtml(fmt(net))}</span></div>
              </div>
              <div class="foot">
                <div>Brutto: <strong class="mono">${escapeHtml(fmt(raw))}</strong></div>
                <div>Status: <strong>${escapeHtml(statusText)}</strong> <span class="mono">${escapeHtml(reasonHuman ? `(${reasonHuman})` : "")}</span></div>
              </div>
            </div>
          `;
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda edge calculator: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }

      // Lag vs latency
      const lagBlocks = Array.from(contentEl.querySelectorAll("[data-lag-latency]"));
      for (const el of lagBlocks){
        const file = el.getAttribute("data-lag-latency");
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const obj = await r.json();

          const lagMs = Number(obj?.market_lag_ms ?? NaN);
          const sysMs = Number(obj?.system_latency_ms ?? NaN);
          const has = Number.isFinite(lagMs) && Number.isFinite(sysMs);
          // Guard: very small lag estimates are often unstable/meaningless (esp right after restart).
          const minMeaningfulLagMs = 100;
          const tooSmallLag = has ? (lagMs >= 0 && lagMs < minMeaningfulLagMs) : false;
          const ok = (has && !tooSmallLag) ? (sysMs < lagMs) : null;

          const ringCls = (vOk) => vOk === null ? "warn" : (vOk ? "good" : "bad");
          const fmtMs = (n) => Number.isFinite(n) ? `${Math.round(n)}ms` : "–";

          el.innerHTML = `
            ${renderBlockMetaLine(file, lmMs)}
            <div class="gauges">
              <div class="gauge">
                <div class="ring ${escapeHtml(ringCls(ok))}"></div>
                <div>
                  <p class="name">Market Lag</p>
                  <p class="val mono">${escapeHtml(fmtMs(lagMs))}</p>
                  <p class="hint">PM efter Kraken (est)</p>
                </div>
              </div>
              <div class="gauge">
                <div class="ring ${escapeHtml(ringCls(ok))}"></div>
                <div>
                  <p class="name">System Latency</p>
                  <p class="val mono">${escapeHtml(fmtMs(sysMs))}</p>
                  <p class="hint">Loop → snapshot</p>
                </div>
              </div>
            </div>
            <p class="muted" style="margin-top:10px">Status: <strong>${escapeHtml(ok === null ? (tooSmallLag ? "WARN (lag ~0, osäkert)" : "INGEN DATA") : (ok ? "OK (snabbare än marknaden)" : "SENT (långsammare än marknaden)"))}</strong></p>
          `;
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda lag/latency: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }

      // Missed opportunities (from edge_calculator_live.csv)
      const missedBlocks = Array.from(contentEl.querySelectorAll("[data-missed-opps]"));
      for (const el of missedBlocks){
        const file = el.getAttribute("data-missed-opps");
        const maxRows = parseInt(el.getAttribute("data-max-rows") || "25", 10);
        try{
          const r = await fetch(`./data/${file}`, { cache: "no-store" });
          if (!r.ok) throw new Error(`${file} (${r.status})`);
          const lm = r.headers.get("Last-Modified");
          const lmMs = lm ? new Date(lm).getTime() : NaN;
          const text = await r.text();
          const rows = parseCsv(text);
          if (rows.length < 2){
            el.innerHTML = renderBlockMetaLine(file, lmMs) + `<p class="muted">Ingen data.</p>`;
            continue;
          }
          const head = rows[0];
          const hi = head.map(h => String(h || "").trim());
          const idx = (name) => hi.indexOf(name);
          const iStatus = idx("execution_status");
          const iReason = idx("reason");

          const missed = [rows[0]];
          for (let i = rows.length - 1; i >= 1 && missed.length <= maxRows; i--){
            const rr = rows[i];
            const st = String(rr[iStatus] ?? "").toUpperCase();
            if (st !== "SKIPPED") continue;
            const reason = String(rr[iReason] ?? "");
            if (!reason) continue;
            const rr2 = rr.slice();
            rr2[iReason] = humanizeReason(reason);
            missed.push(rr2);
          }

          el.innerHTML = renderBlockMetaLine(file, lmMs) + renderTableFromRows(missed, maxRows);
        }catch(e){
          el.innerHTML = `<p class="muted">Kunde inte ladda missed opportunities: <span class="mono">${escapeHtml(String(e))}</span></p>`;
        }
      }
    }

    // ----------------------------
    // Events
    // ----------------------------
    window.addEventListener("hashchange", render);

    // Init
    buildNav();
    if (!location.hash) location.hash = DEFAULT_ROUTE;
    render();
  </script>
</body>
</html>
